   1               	# 1 "a.S"
   1               	
   1               	...
   0               	
   0               	
   2               	/*
   3               	 *  DISCLAIMER"
   4               	 *
   5               	 *  Copyright Â© 2020, Alvaro Gomes Sobral Barcellos,
   6               	 *
   7               	 *  Permission is hereby granted, free of charge, to any person obtaining
   8               	 *  a copy of this software and associated documentation files (the
   9               	 *  "Software"), to deal in the Software without restriction, including
  10               	 *  without limitation the rights to use, copy, modify, merge, publish,
  11               	 *  distribute, sublicense, and/or sell copies of the Software, and to
  12               	 *  permit persons to whom the Software is furnished to do so, subject to
  13               	 *  the following conditions"
  14               	 *
  15               	 *  The above copyright notice and this permission notice shall be
  16               	 *  included in all copies or substantial portions of the Software.
  17               	 *
  18               	 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
  19               	 *  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
  20               	 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
  21               	 *  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
  22               	 *  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
  23               	 *  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
  24               	 *
  25               	 */
  26               	
  27               	;
  28               	;    those are to stay at NRWW flash memory of atmega8
  29               	;
  30               	.org FLASH_NRWW
  31               	.align 2
  32               	;
  33               	; spm instruction uses:
  34               	; r31:r30 address in bytes, r1:r0 data, 
  35               	; uses register r2 as command and scratch
  36               	; uses register r4 as keeper of SREG
  37               	;
  38               	#ifndef _WORK_
  39               		_work_ = r2
  40               		_sreg_ = r4
  41               	#endif
  42               	
  43               	do_spm:
  44:a.S           **** 	in _sreg_, __SREG__
  45:a.S           **** 	cli
  46:a.S           ****     sts SPMCR, _work_
  47:a.S           ****     spm
  48               	
  49               	10:
  50               	;   wait spm done
  51:a.S           ****     lds _work_, SPMCR
  52:a.S           ****     sbrc _work_, SPMEN
  53:a.S           ****     rjmp 10b
  54               	
  55               	; if erase or write, force enable RWW section 
  56               	
  57:a.S           ****     andi _work_, (1<<PGERS) | (1<<PGWRT)
  58:a.S           ****     breq 10f
  59               	
  60               	; enable rww 
  61:a.S           ****     ldi _work_, (1<<RWWSRE) | (1<<SPMEN)
  62:a.S           ****     sts SPMCR, _work_
  63:a.S           ****     spm 
  64               	10:
  65:a.S           **** 	out __SREG__, _sreg_
  66:a.S           **** 	sei
  67:a.S           ****     ret
  68               	
  69               	.equ free_nrww, .
